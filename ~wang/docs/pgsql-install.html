<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" xml:lang="zh">
<head>
<title>PostgreSQL Installation</title>
<!-- 2014-10-08 Wed 09:40 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Tommy Wang" />
<link rel="shortcut icon" href="http://gaixie.org/favicon.ico?1" type="image/x-icon" />
<link rel="stylesheet" href="/css/style.css" type="text/css" />
<link rel="stylesheet" href="/css/org.css" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">PostgreSQL Installation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 编译环境</a></li>
<li><a href="#sec-2">2. 下载最新的源码包</a></li>
<li><a href="#sec-3">3. 编译安装到指定目录</a></li>
<li><a href="#sec-4">4. 创建一个数据库管理员用户</a></li>
<li><a href="#sec-5">5. 数据库初始化</a></li>
<li><a href="#sec-6">6. 数据库访问设置</a></li>
<li><a href="#sec-7">7. 启动数据库</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 编译环境</h2>
<div class="outline-text-2" id="text-1">
<p>
Mac OSX 下只要装了 Xcode 就行，所有编译需要的工具和类库都有了。CentOS 下需要安装下面的软件包。
</p>
<pre class="example">
$ sudo yum install make gcc readline-devel zlib-devel flex bison
</pre>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 下载最新的源码包</h2>
<div class="outline-text-2" id="text-2">
<p>
Linux 下我喜欢把一些大软件的源码包下载到 /usr/local/src 目录下，Mac OSX 默认没有这个目录，需要创建一个，
然后从 PostgreSQL <a href="http://www.postgresql.org/ftp/source/">官网下载</a> 最新的源码包。
</p>
<pre class="example">
$ sudo mkdir /usr/local/src
$ cd /usr/local/src
$ sudo curl -O http://ftp.postgresql.org/pub/source/v9.4beta2/postgresql-9.4beta2.tar.gz
$ sudo tar xzvf postgresql-9.4beta2.tar.gz
</pre>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 编译安装到指定目录</h2>
<div class="outline-text-2" id="text-3">
<p>
将 9.4beta2 这个版本编译并安装到 /usr/local/pgsql/9.4beta2 这个目录下，然后为该目录创建一个 default的软链接，表示当先正在使用的数据库版本。
</p>
<pre class="example">
$ cd /usr/local/src/postgresql-9.4beta2
$ sudo ./configure --prefix=/usr/local/pgsql/9.4beta2
$ sudo make
$ sudo make install
$ sudo make clean
$ sudo ln -s /usr/local/pgsql/9.4beta2 /usr/local/pgsql/default
</pre>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 创建一个数据库管理员用户</h2>
<div class="outline-text-2" id="text-4">
<p>
Mac OSX 下不能直接创建用户，因为新增的用户默认都有管理员权限，好在系统默认有一个 _postgres 用户可以直接用。
CentOS 下还是需要老老实实的创建一个 postgres 用户。注意两个系统的用户名不同，Mac OSX 的带一个下划线。
</p>
<pre class="example">
$ sudo useradd -c "PostgreSQL Server" postgres
</pre>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 数据库初始化</h2>
<div class="outline-text-2" id="text-5">
<p>
创建一个目录 /var/lib/pgsql，用来存贮数据库的数据文件。并为 postgres 设置访问权限。
用 postgres 创建一个当前主版本的数据目录 9.4，并做一个 default 软链接。注意在 initdb 时指定一个数据库超级用户 postgres，
否则 Mac OSX 使用默认的 _postgres 会有问题。
</p>
<pre class="example">
$ sudo mkdir /var/lib/pgsql
$ sudo chown postgres:postgres /var/lib/pgsql

# 如果是 Mac OSX 应该是 _postgres:wheel 
$ sudo chown _postgres:wheel /var/lib/pgsql

$ sudo -u postgres mkdir /var/lib/pgsql/9.4
$ sudo -u postgres ln -s /var/lib/pgsql/9.4 /var/lib/pgsql/default
$ sudo -u postgres /usr/local/pgsql/default/bin/initdb -D /var/lib/pgsql/default/data -U postgres
</pre>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> 数据库访问设置</h2>
<div class="outline-text-2" id="text-6">
<p>
Mac OSX 主要是本机测试用，不用做下面的设置，如果是 CentOS 服务器上需要下面的设置。
首先指定可以访问数据库的客户端 ip。
</p>
<pre class="example">
$ sudo vi /var/lib/pgsql/default/data/pg_hba.conf
</pre>

<p>
修改防火墙配置，放行 5432 端口的访问。
</p>
<pre class="example">
$ sudo vi /etc/sysconfig/iptables
.....
-A INPUT -m state --state NEW -m tcp -p tcp --dport 5432 -j ACCEPT
.....

$ sudo service iptables restart
</pre>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> 启动数据库</h2>
<div class="outline-text-2" id="text-7">
<p>
用 postgres 用户启动数据库，并允许外部客户端通过 5432 端口进行访问，只是本机自用的话就去掉 -i 的启动参数。
</p>
<pre class="example">
$ sudo su -l postgres
$ /usr/local/pgsql/default/bin/pg_ctl \
    -D /var/lib/pgsql/default/data -o '-i -p 5432' \
    -l /var/lib/pgsql/default/pgstartup.log start
</pre>
</div>
</div>
</div>
</body>
</html>
